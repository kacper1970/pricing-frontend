<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oblicz cenę usługi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      background-color: #f9f9f9;
    }
    h1, h2, h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    select, input, textarea {
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
    }
    button {
      margin-top: 2rem;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
    }
    #summary ul {
      list-style: none;
      padding: 0;
    }
    #summary li {
      margin-bottom: 0.5rem;
    }
    #summary h3 {
      color: green;
    }
  </style>
</head>
<body>
  <h1>Kalkulator ceny usługi</h1>

  <form id="pricing-form">
    <label for="service">Usługa:</label>
    <select id="service" name="service" required>
      <option value="">-- Wybierz usługę --</option>
    </select>

    <label><input type="checkbox" id="is-housing" name="is-housing"> Spółdzielnia</label>

    <div id="street-wrapper">
      <label for="street">Ulica:</label>
      <input type="text" id="street" name="street">
    </div>

    <div id="street-select-wrapper" style="display: none;">
      <label for="street-select">Ulica (lista spółdzielni):</label>
      <select id="street-select" name="street-select">
        <option value="">-- Wybierz ulicę --</option>
      </select>
    </div>

    <label for="number">Nr domu:</label>
    <input type="text" id="number" name="number" required>

    <label for="apartment">Nr mieszkania:</label>
    <input type="text" id="apartment" name="apartment">

    <label for="postal">Kod pocztowy:</label>
    <input type="text" id="postal" name="postal" pattern="\d{2}-\d{3}" required>

    <label for="city">Miasto:</label>
    <input type="text" id="city" name="city" required>

    <label for="vat">Stawka VAT:</label>
    <select id="vat" name="vat">
      <option value="8">8%</option>
      <option value="23">23%</option>
    </select>

    <label for="date">Data wizyty:</label>
    <input type="date" id="date" name="date" required>

    <label for="slot">Dostępne godziny:</label>
    <select id="slot" name="slot" required>
      <option value="">-- Wybierz godzinę --</option>
    </select>

    <label for="package">Pakiet:</label>
    <select id="package" name="package">
      <option value="safe">Safe</option>
      <option value="comfort">Comfort</option>
      <option value="priority">Priority</option>
      <option value="all">All Inclusive</option>
    </select>

    <label><input type="checkbox" id="override" name="override"> Wymuś wizytę natychmiastową</label>

    <label for="name">Imię i nazwisko:</label>
    <input type="text" id="name" name="name" required>

    <label for="phone">Telefon kontaktowy:</label>
    <input type="tel" id="phone" name="phone" required>

    <label for="problem">Opis problemu:</label>
    <textarea id="problem" name="problem" rows="3"></textarea>

    <button type="submit">Oblicz cenę</button>
    <button type="button" id="book-btn" style="display:none; background-color: #4CAF50; color: white;">ZAREZERWUJ</button>
  </form>

  <div id="summary"></div>

  <script>
    const PRICING_API = "https://pricing-service.onrender.com";
    const CALENDAR_API = "https://calendar-service-pl5m.onrender.com";

    let selectedDuration = 60;

    fetch(`${PRICING_API}/pricing/services`)
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("service");
        data.services.forEach(service => {
          const opt = document.createElement("option");
          opt.value = service;
          opt.textContent = service;
          select.appendChild(opt);
        });
      });

    document.getElementById("service").addEventListener("change", function () {
      const service = this.value;
      if (!service) return;

      fetch(`${PRICING_API}/pricing/full?` + new URLSearchParams({
        service, address: "Test", vat: 8, date: "2025-01-01", time: "08:00", package: "safe"  // placeholder
      }))
        .then(res => res.json())
        .then(data => {
          const czas = parseInt(data.base?.czas || "60");
          selectedDuration = isNaN(czas) ? 60 : czas;
        });
    });

    document.getElementById("is-housing").addEventListener("change", function() {
      const checked = this.checked;
      document.getElementById("street-wrapper").style.display = checked ? "none" : "block";
      document.getElementById("street-select-wrapper").style.display = checked ? "block" : "none";
      if (checked) {
        fetch(`${PRICING_API}/pricing/local-streets`)
          .then(res => res.json())
          .then(data => {
            const select = document.getElementById("street-select");
            select.innerHTML = '<option value="">-- Wybierz ulicę --</option>';
            data.streets.forEach(street => {
              const opt = document.createElement("option");
              opt.value = street;
              opt.textContent = street;
              select.appendChild(opt);
            });
          });
      }
    });

    document.getElementById("date").addEventListener("change", function () {
      const date = this.value;
      if (!date) return;

      fetch(`${CALENDAR_API}/available-slots?date=${date}&duration=${selectedDuration}`)
        .then(res => res.json())
        .then(data => {
          const slotSelect = document.getElementById("slot");
          slotSelect.innerHTML = '<option value="">-- Wybierz godzinę --</option>';
          data.free_slots.forEach(slot => {
            const opt = document.createElement("option");
            opt.value = slot;
            opt.textContent = slot;
            slotSelect.appendChild(opt);
          });
        });
    });

    document.getElementById("pricing-form").addEventListener("submit", function(e) {
      e.preventDefault();

      const isHousing = this.is_housing.checked;
      const street = isHousing ? this["street-select"].value : this.street.value;
      const number = this.number.value;
      const apartment = this.apartment.value;
      const postal = this.postal.value;
      const city = this.city.value;

      let address = `${street} ${number}`;
      if (apartment) address += `/${apartment}`;
      address += `, ${postal} ${city}`;

      const service = this.service.value;
      const vat = this.vat.value;
      const date = this.date.value;
      const slot = this.slot.value;
      const time = slot.split("–")[0];
      const package = this.package.value;
      const override = this.override.checked;

      fetch(`${PRICING_API}/pricing/full?` + new URLSearchParams({
        service, address, vat, date, time, package, override
      }))
        .then(res => res.json())
        .then(data => {
          window.calculatedData = data;
          const summary = document.getElementById("summary");
          summary.innerHTML = `
            <h2>Podsumowanie ceny</h2>
            <ul>
              <li>🔧 Usługa: <strong>${data.service}</strong></li>
              <li>📍 Lokalizacja: <strong>${data.location.location_type}</strong> (modyfikator: ${data.location.modifier})</li>
              <li>📅 Termin: <strong>${date}</strong> (typ: ${data.when.type}, modyfikator: ${data.when.modifier})</li>
              <li>⏰ Slot: <strong>${data.slot.slot}</strong> (modyfikator: ${data.slot.modifier})</li>
              <li>📦 Pakiet: <strong>${data.package.name}</strong> (modyfikator: ${data.package.modifier})</li>
            </ul>
            <h3>💰 Cena końcowa: <span style="font-size: 1.5rem;">${data.final_price.toFixed(2)} zł</span></h3>
          `;
          document.getElementById("book-btn").style.display = "block";
        });
    });

    document.getElementById("book-btn").addEventListener("click", function() {
      const form = document.getElementById("pricing-form");
      const slot = form.slot.value;
      const isHousing = form.is_housing.checked;
      const street = isHousing ? form["street-select"].value : form.street.value;
      const number = form.number.value;
      const apartment = form.apartment.value;
      const postal = form.postal.value;
      const city = form.city.value;

      let address = `${street} ${number}`;
      if (apartment) address += `/${apartment}`;
      address += `, ${postal} ${city}`;

      const payload = {
        date: form.date.value,
        slot: slot,
        name: form.name.value,
        phone: form.phone.value,
        address: address,
        problem: form.problem.value,
        urgency: window.calculatedData?.when?.type?.toLowerCase() || "standard",
        override_now: form.override.checked
      };

      fetch(`${CALENDAR_API}/book`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => {
          alert("✅ Zarezerwowano wizytę!\n\n" + (data.event_link || ""));
        });
    });
  </script>
</body>
</html>
