<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oblicz cenÄ™ usÅ‚ugi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      background-color: #f9f9f9;
    }
    h1, h2, h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    select, input, textarea {
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
    }
    button {
      margin-top: 2rem;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
    }
    #summary ul {
      list-style: none;
      padding: 0;
    }
    #summary li {
      margin-bottom: 0.5rem;
    }
    #summary h3 {
      color: green;
    }
    #status {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Kalkulator ceny usÅ‚ugi</h1>

  <form id="pricing-form">
    <!-- UsÅ‚uga -->
    <label for="service">UsÅ‚uga:</label>
    <select id="service" name="service" required>
      <option value="">-- Wybierz usÅ‚ugÄ™ --</option>
    </select>

    <!-- SpÃ³Å‚dzielnia / ulica -->
    <label>
      <input type="checkbox" id="is-housing" name="is-housing">
      SpÃ³Å‚dzielnia
    </label>

    <div id="street-wrapper">
      <label for="street">Ulica:</label>
      <input type="text" id="street" name="street">
    </div>

    <div id="street-select-wrapper" style="display: none;">
      <label for="street-select">Ulica (lista spÃ³Å‚dzielni):</label>
      <select id="street-select" name="street-select">
        <option value="">-- Wybierz ulicÄ™ --</option>
      </select>
    </div>

    <!-- Adres: numer, mieszkanie, kod, miasto -->
    <label for="number">Nr domu:</label>
    <input type="text" id="number" name="number" required>

    <label for="apartment">Nr mieszkania:</label>
    <input type="text" id="apartment" name="apartment">

    <label for="postal">Kod pocztowy:</label>
    <input type="text" id="postal" name="postal" pattern="\d{2}-\d{3}" required>

    <label for="city">Miasto:</label>
    <input type="text" id="city" name="city" required>

    <!-- VAT -->
    <label for="vat">Stawka VAT:</label>
    <select id="vat" name="vat">
      <option value="8">8%</option>
      <option value="23">23%</option>
    </select>

    <!-- Data i godzina -->
    <label for="date">Data wizyty:</label>
    <input type="date" id="date" name="date" required>

    <label for="slot">DostÄ™pne godziny:</label>
    <select id="slot" name="slot" required>
      <option value="">-- Wybierz godzinÄ™ --</option>
    </select>

    <!-- Pakiet -->
    <label for="package">Pakiet:</label>
    <select id="package" name="package">
      <option value="safe">Safe</option>
      <option value="comfort">Comfort</option>
      <option value="priority">Priority</option>
      <option value="all">All Inclusive</option>
    </select>

    <!-- Inne -->
    <label>
      <input type="checkbox" id="override" name="override">
      WymuÅ› wizytÄ™ natychmiastowÄ…
    </label>

    <!-- Dane kontaktowe -->
    <label for="name">ImiÄ™ i nazwisko:</label>
    <input type="text" id="name" name="name" required>

    <label for="phone">Telefon kontaktowy:</label>
    <input type="tel" id="phone" name="phone" required>

    <label for="problem">Opis problemu:</label>
    <textarea id="problem" name="problem" rows="3"></textarea>

    <!-- Przycisk -->
    <button type="submit">Oblicz cenÄ™</button>
    <button type="button" id="book-btn" style="display:none; background-color: #4CAF50; color: white;">ZAREZERWUJ</button>
  </form>

  <!-- Podsumowanie i komunikaty -->
  <div id="summary"></div>
  <div id="status" style="margin-top: 1rem; font-weight: bold;"></div>
</body>
  
// ğŸ”§ KONFIGURACJA API
const PRICING_API = "https://pricing-service.onrender.com";
const CALENDAR_API = "https://calendar-service-pl5m.onrender.com";

let selectedDuration = 60; // DomyÅ›lny czas trwania wizyty

// ğŸ§± Funkcja budujÄ…ca adres z formularza
function buildFullAddress(form) {
  const isHousing = form.is_housing.checked;
  const street = isHousing ? form["street-select"].value : form.street.value;
  const number = form.number.value;
  const apartment = form.apartment.value;
  const postal = form.postal.value;
  const city = form.city.value;

  let address = `${street} ${number}`;
  if (apartment) address += `/${apartment}`;
  address += `, ${postal} ${city}`;
  return address;
}

// ğŸ”½ Pobierz listÄ™ usÅ‚ug
fetch(`${PRICING_API}/pricing/services`)
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById("service");
    data.services.forEach(service => {
      const opt = document.createElement("option");
      opt.value = service;
      opt.textContent = service;
      select.appendChild(opt);
    });
  });

// ğŸ” Po zmianie usÅ‚ugi â€“ pobierz czas trwania

document.getElementById("service").addEventListener("change", () => {
  const form = document.getElementById("pricing-form");
  const service = form.service.value;
  if (!service || !form.date.value || !form.slot.value) return;

  const address = buildFullAddress(form);
  const date = form.date.value;
  const time = form.slot.value.split("â€“")[0];
  const packageName = form.package.value || "safe";

  fetch(`${PRICING_API}/pricing/full?` + new URLSearchParams({
    service,
    address,
    vat: 8,
    date,
    time,
    package: packageName
  }))
    .then(res => res.json())
    .then(data => {
      const czas = parseInt(data.base?.czas || "60");
      selectedDuration = isNaN(czas) ? 60 : czas;
    });
});

// ğŸ¢ PrzeÅ‚Ä…cznik spÃ³Å‚dzielni

document.getElementById("is-housing").addEventListener("change", function () {
  const checked = this.checked;
  document.getElementById("street-wrapper").style.display = checked ? "none" : "block";
  document.getElementById("street-select-wrapper").style.display = checked ? "block" : "none";

  if (checked) {
    fetch(`${PRICING_API}/pricing/local-streets`)
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("street-select");
        select.innerHTML = '<option value="">-- Wybierz ulicÄ™ --</option>';
        data.streets.forEach(street => {
          const opt = document.createElement("option");
          opt.value = street;
          opt.textContent = street;
          select.appendChild(opt);
        });
      });
  }
});

// ğŸ“… Zmiana daty â†’ pobierz sloty

document.getElementById("date").addEventListener("change", function () {
  const date = this.value;
  if (!date) return;

  fetch(`${CALENDAR_API}/available-slots?date=${date}&duration=${selectedDuration}`)
    .then(res => res.json())
    .then(data => {
      const slotSelect = document.getElementById("slot");
      slotSelect.innerHTML = '<option value="">-- Wybierz godzinÄ™ --</option>';
      data.free_slots.forEach(slot => {
        const opt = document.createElement("option");
        opt.value = slot;
        opt.textContent = slot;
        slotSelect.appendChild(opt);
      });
    });
});

  // ğŸ§® Oblicz cenÄ™ i wyÅ›wietl podsumowanie

document.getElementById("pricing-form").addEventListener("submit", function (e) {
  e.preventDefault();
  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "";

  const address = buildFullAddress(this);
  const service = this.service.value.trim();
  const vat = this.vat.value;
  const date = this.date.value;
  const slot = this.slot.value;
  if (!slot) {
    statusDiv.style.color = "red";
    statusDiv.textContent = "âŒ ProszÄ™ wybraÄ‡ godzinÄ™ wizyty.";
    return;
  }
  const time = slot.includes("â€“") ? slot.split("â€“")[0].trim() : slot;
  const packageName = this.package.value;
  const override = this.override.checked.toString();

  if (!service || !address || !date) {
    statusDiv.style.color = "red";
    statusDiv.textContent = "âŒ UzupeÅ‚nij wszystkie wymagane pola.";
    return;
  }

  fetch(`${PRICING_API}/pricing/full?` + new URLSearchParams({
    service,
    address,
    vat,
    date,
    time,
    package: packageName,
    override
  }))
    .then(res => res.ok ? res.json() : Promise.reject("BÅ‚Ä…d: " + res.status))
    .then(data => {
      if (data.error) throw new Error(data.error);

      window.calculatedData = data;
      const summary = document.getElementById("summary");
      summary.innerHTML = `
        <h2>Podsumowanie ceny</h2>
        <ul>
          <li>ğŸ”§ UsÅ‚uga: <strong>${data.service}</strong></li>
          <li>ğŸ“ Lokalizacja: <strong>${data.location.location_type}</strong> (modyfikator: ${data.location.modifier})</li>
          <li>ğŸ“… Termin: <strong>${date}</strong> (typ: ${data.when.type}, modyfikator: ${data.when.modifier})</li>
          <li>â° Slot: <strong>${data.slot.slot}</strong> (modyfikator: ${data.slot.modifier})</li>
          <li>ğŸ“¦ Pakiet: <strong>${data.package.name}</strong> (modyfikator: ${data.package.modifier})</li>
        </ul>
        <h3>ğŸ’° Cena koÅ„cowa: <span style="font-size: 1.5rem;">${data.final_price.toFixed(2)} zÅ‚</span></h3>
      `;

      statusDiv.style.color = "green";
      statusDiv.textContent = "âœ… Dane poprawne â€“ wycena zostaÅ‚a przeprowadzona.";
      document.getElementById("book-btn").style.display = "block";
    })
    .catch(err => {
      statusDiv.style.color = "red";
      statusDiv.textContent = "âŒ BÅ‚Ä…d obliczania ceny: " + err.message;
      console.error(err);
    });
});

// ğŸ“… Rezerwacja

document.getElementById("book-btn").addEventListener("click", function () {
  const form = document.getElementById("pricing-form");
  const slot = form.slot.value;
  const address = buildFullAddress(form);

  const payload = {
    date: form.date.value,
    slot: slot,
    name: form.name.value,
    phone: form.phone.value,
    address: address,
    problem: form.problem.value,
    urgency: window.calculatedData?.when?.type?.toLowerCase() || "standard",
    override_now: form.override.checked
  };

  fetch(`${CALENDAR_API}/book`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(data => {
      alert("âœ… Zarezerwowano wizytÄ™!\n\n" + (data.event_link || ""));
    });
});
