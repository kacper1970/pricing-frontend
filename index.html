<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>ENERTIA – Kalkulator usług</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 12px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 16px;
      background-color: #007BFF;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    #result {
      margin-top: 25px;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Kalkulator ceny – ENERTIA</h1>

  <label for="service">Wybierz usługę</label>
  <select id="service"></select>

  <label for="address">Adres wykonania usługi</label>
  <input type="text" id="address" placeholder="np. Piasta 14, Świebodzice, 58-160, Polska" />

  <label for="date">Data realizacji</label>
  <input type="date" id="date" />

  <label for="time">Godzina rozpoczęcia (HH:MM)</label>
  <input type="time" id="time" />

  <label for="package">Pakiet</label>
  <select id="package">
    <option value="safe">Pakiet Safe (0%)</option>
    <option value="comfort">Pakiet Comfort (+25%)</option>
    <option value="priority">Pakiet Priority (+50%)</option>
    <option value="all">Pakiet All Inclusive (+100%)</option>
  </select>

  <label>
    <input type="checkbox" id="override" />
    Wymuś tryb NATYCHMIASTOWY (override)
  </label>

  <button onclick="calculate()">Oblicz cenę</button>

  <div id="result"></div>

  <script>
    async function loadServices() {
      try {
        const response = await fetch("https://pricing-service.onrender.com/pricing/services");
        const data = await response.json();
        const select = document.getElementById("service");

        data.forEach(service => {
          const opt = document.createElement("option");
          opt.value = service;
          opt.textContent = service;
          select.appendChild(opt);
        });
      } catch (error) {
        console.error("Błąd podczas ładowania usług:", error);
      }
    }

    async function calculate() {
      const service = document.getElementById("service").value;
      const address = document.getElementById("address").value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const pkg = document.getElementById("package").value;
      const override = document.getElementById("override").checked;

      if (!service || !address || !date || !time) {
        document.getElementById("result").innerText = "Uzupełnij wszystkie pola.";
        return;
      }

      const url = new URL("https://pricing-service.onrender.com/pricing/full");
      url.searchParams.append("service", service);
      url.searchParams.append("address", address);
      url.searchParams.append("date", date);
      url.searchParams.append("time", time);
      url.searchParams.append("package", pkg);
      url.searchParams.append("override", override);

      try {
        const response = await fetch(url);
        const data = await response.json();
        console.log("Odpowiedź z API:", data);

        if (response.ok) {
          const price = data.final_price;
          const breakdown = `
            Usługa: ${data.service} (${data.base.netto} netto)
            ➤ Lokalizacja: ${data.location.location_type} (${data.location.modifier})
            ➤ Data: ${date} (${data.when.type}, ${data.when.modifier})
            ➤ Slot: ${data.slot.slot} (${data.slot.modifier})
            ➤ Pakiet: ${data.package.name} (${data.package.modifier})
            ➤ Finalna cena brutto: ${price} zł
          `;
          document.getElementById("result").innerText = breakdown;
        } else {
          document.getElementById("result").innerText = "Błąd: " + (data.error || "Nieznany błąd");
        }
      } catch (error) {
        document.getElementById("result").innerText = "Błąd połączenia z serwerem.";
        console.error(error);
      }
    }

    loadServices();
  </script>
</body>
</html>
